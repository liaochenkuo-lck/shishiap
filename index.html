<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 网页标题 -->
    <title>GPA计算器 | GPA Calculator</title>
    <!-- 引入外部资源（如图标、Excel 导出库） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- 内嵌 CSS 样式（计算器的外观） -->
    <style>
        /* 这里是你之前的所有 CSS 代码，确保界面正常显示 */
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f5f7f9; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        /* （省略其他 CSS 代码，保持和你之前的双语版一致） */
    </style>
</head>
<body>
    <!-- 页面内容（计算器的可视化界面） -->
    <div class="container">
        <!-- 头部（标题 + 语言切换） -->
        <header>
            <h1>
                <span class="lang-zh">GPA计算器</span>
                <span class="lang-en lang-hidden">GPA Calculator</span>
            </h1>
            <div class="language-switch">
                <button class="lang-btn active" data-lang="zh">中文</button>
                <button class="lang-btn" data-lang="en">English</button>
            </div>
        </header>
        
        <!-- 描述文字 -->
        <div class="description">
            <span class="lang-zh">本计算器支持三种GPA计算体系（4.3制、5.0制和4.0制）...</span>
            <span class="lang-en lang-hidden">This calculator supports three GPA systems...</span>
        </div>
        
        <!-- 课程表格（核心交互区域） -->
        <div class="spreadsheet-container">
            <table id="courses-table">
                <thead>
                    <tr>
                        <th class="fixed-column">
                            <span class="lang-zh">序号</span>
                            <span class="lang-en lang-hidden">No.</span>
                        </th>
                        <th class="subject-cell">
                            <span class="lang-zh">科目名称</span>
                            <span class="lang-en lang-hidden">Course Name</span>
                        </th>
                        <!-- （省略其他表格列，保持和你之前的代码一致） -->
                    </tr>
                </thead>
                <tbody>
                    <!-- 表格内容由 JS 动态生成 -->
                </tbody>
            </table>
        </div>
        
        <!-- GPA 结果显示 -->
        <div class="gpa-summary">
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">平均GPA (4.3制)</span>
                    <span class="lang-en lang-hidden">Average GPA (4.3 Scale)</span>
                </div>
                <div class="gpa-value" id="gpa-4-3">0.00</div>
            </div>
            <!-- （省略其他 GPA 结果框） -->
        </div>
    </div>
    
    <!-- 交互逻辑（JS 代码，实现成绩计算、语言切换、Excel 导出） -->
    <script>
        // 这里是你之前的所有 JavaScript 代码，包括：
        // 1. 课程数据（含中英文名称）
        // 2. 表格动态生成逻辑
        // 3. GPA 计算核心算法
        // 4. 语言切换功能
        // 5. Excel 导出功能
        // （保持和你之前的双语版代码完全一致即可）

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA计算器 | GPA Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        header {
            background: #4a6bdf;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .language-switch {
            position: absolute;
            right: 20px;
            top: 20px;
        }
        .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            transition: background 0.3s;
        }
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: bold;
        }
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .version-info {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.9;
        }
        .description {
            padding: 15px 20px;
            background: #f0f4ff;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            line-height: 1.5;
        }
        .action-buttons {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 10px;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        .export-btn:hover {
            background-color: #218838;
        }
        .export-excel-btn {
            background-color: #ffc107;
            color: #212529;
        }
        .export-excel-btn:hover {
            background-color: #e0a800;
        }
        .spreadsheet-container {
            overflow-x: auto;
            max-height: 65vh;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #dde;
            padding: 8px 5px;
            text-align: center;
            min-width: 60px;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 5;
        }
        .subject-cell {
            text-align: left;
            min-width: 200px;
        }
        .input-cell {
            background-color: #e6f7ff;
        }
        .input-cell select, .input-cell input {
            width: 100%;
            border: 1px solid #aac;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }
        .result-cell {
            background-color: #fffae0;
            font-weight: 500;
        }
        .summary-row {
            background-color: #e8f4ff;
            font-weight: bold;
        }
        .instructions {
            padding: 20px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            font-size: 14px;
            line-height: 1.6;
        }
        .instructions h3 {
            margin-top: 0;
            color: #4a6bdf;
        }
        .instructions ul {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 14px;
        }
        .gpa-summary {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f0f8ff;
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        .gpa-box {
            text-align: center;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 140px;
        }
        .gpa-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a6bdf;
        }
        .honors-group {
            background-color: #fff5f5;
        }
        .honors-tag {
            display: inline-block;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .alert-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            border: 1px solid #ffeeba;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            background-color: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background-color: #dc3545;
        }
        .semester-label {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .lang-hidden {
            display: none;
        }
        @media (max-width: 768px) {
            th, td {
                padding: 6px 3px;
                font-size: 12px;
            }
            .gpa-summary {
                flex-direction: column;
                gap: 10px;
            }
            .action-buttons {
                justify-content: center;
            }
            .language-switch {
                position: static;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span class="lang-zh">GPA计算器</span>
                <span class="lang-en lang-hidden">GPA Calculator</span>
            </h1>
            <div class="version-info">
                <span class="lang-zh">支持上下学期 | 每门课程可分学期填写成绩</span>
                <span class="lang-en lang-hidden">Supports Semesters | Enter grades for each course in separate semesters</span>
            </div>
            <div class="language-switch">
                <button class="lang-btn active" data-lang="zh">中文</button>
                <button class="lang-btn" data-lang="en">English</button>
            </div>
        </header>
        
        <div class="description">
            <span class="lang-zh">本计算器支持三种GPA计算体系（4.3制、5.0制和4.0制），并允许每门课程在上下两个学期分别填写分数。有成绩的课程将被视为已修读。</span>
            <span class="lang-en lang-hidden">This calculator supports three GPA systems (4.3 scale, 5.0 scale, and 4.0 scale) and allows entering grades for each course in two separate semesters. Courses with entered grades will be considered as completed.</span>
        </div>
        
        <div class="alert-message">
            <i class="fas fa-info-circle"></i>
            <span class="lang-zh">提示：同名的普通课程和荣誉课程只能选择其一，但可在不同学期分别修读。</span>
            <span class="lang-en lang-hidden">Note: You can only choose either the regular or honors version of the same course in a semester, but you can take them in different semesters.</span>
        </div>
        
        <div class="action-buttons">
            <button id="export-excel" class="export-btn export-excel-btn">
                <i class="fas fa-file-excel"></i>
                <span class="lang-zh">导出Excel表格</span>
                <span class="lang-en lang-hidden">Export to Excel</span>
            </button>
        </div>
        
        <div class="spreadsheet-container">
            <table id="courses-table">
                <thead>
                    <tr>
                        <th class="fixed-column">
                            <span class="lang-zh">序号</span>
                            <span class="lang-en lang-hidden">No.</span>
                        </th>
                        <th class="subject-cell">
                            <span class="lang-zh">科目名称</span>
                            <span class="lang-en lang-hidden">Course Name</span>
                        </th>
                        <th>
                            <span class="lang-zh">荣誉课程</span>
                            <span class="lang-en lang-hidden">Honors</span>
                        </th>
                        <th>
                            <span class="lang-zh">学分</span>
                            <span class="lang-en lang-hidden">Credits</span>
                        </th>
                        <!-- 上学期 -->
                        <th>
                            <span class="lang-zh">上学期<br><span class="semester-label">4.3制分数</span></span>
                            <span class="lang-en lang-hidden">1st Sem<br><span class="semester-label">4.3 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">上学期<br><span class="semester-label">5.0制分数</span></span>
                            <span class="lang-en lang-hidden">1st Sem<br><span class="semester-label">5.0 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">上学期<br><span class="semester-label">4.0制分数</span></span>
                            <span class="lang-en lang-hidden">1st Sem<br><span class="semester-label">4.0 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">上学期<br><span class="semester-label">成绩</span></span>
                            <span class="lang-en lang-hidden">1st Sem<br><span class="semester-label">Grade</span></span>
                        </th>
                        <!-- 下学期 -->
                        <th>
                            <span class="lang-zh">下学期<br><span class="semester-label">4.3制分数</span></span>
                            <span class="lang-en lang-hidden">2nd Sem<br><span class="semester-label">4.3 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">下学期<br><span class="semester-label">5.0制分数</span></span>
                            <span class="lang-en lang-hidden">2nd Sem<br><span class="semester-label">5.0 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">下学期<br><span class="semester-label">4.0制分数</span></span>
                            <span class="lang-en lang-hidden">2nd Sem<br><span class="semester-label">4.0 Scale</span></span>
                        </th>
                        <th>
                            <span class="lang-zh">下学期<br><span class="semester-label">成绩</span></span>
                            <span class="lang-en lang-hidden">2nd Sem<br><span class="semester-label">Grade</span></span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 表格内容将由JavaScript生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="gpa-summary">
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">平均GPA (4.3制)</span>
                    <span class="lang-en lang-hidden">Average GPA (4.3 Scale)</span>
                </div>
                <div class="gpa-value" id="gpa-4-3">0.00</div>
            </div>
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">平均GPA (5.0制)</span>
                    <span class="lang-en lang-hidden">Average GPA (5.0 Scale)</span>
                </div>
                <div class="gpa-value" id="gpa-5-0">0.00</div>
            </div>
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">平均GPA (4.0制)</span>
                    <span class="lang-en lang-hidden">Average GPA (4.0 Scale)</span>
                </div>
                <div class="gpa-value" id="gpa-4-0">0.00</div>
            </div>
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">总获得学分</span>
                    <span class="lang-en lang-hidden">Total Credits Earned</span>
                </div>
                <div class="gpa-value" id="total-credits">0</div>
            </div>
            <div class="gpa-box">
                <div>
                    <span class="lang-zh">总课程数</span>
                    <span class="lang-en lang-hidden">Total Courses</span>
                </div>
                <div class="gpa-value" id="total-courses">0</div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>
                <span class="lang-zh">使用说明：</span>
                <span class="lang-en lang-hidden">Instructions：</span>
            </h3>
            <ul>
                <li>
                    <span class="lang-zh">每门课程可在"上学期成绩"和"下学期成绩"列分别选择对应学期的成绩(A+, A, A-等)</span>
                    <span class="lang-en lang-hidden">For each course, you can select grades (A+, A, A-, etc.) for the first and second semesters separately</span>
                </li>
                <li>
                    <span class="lang-zh">有成绩的课程将自动视为已修读并参与GPA计算</span>
                    <span class="lang-en lang-hidden">Courses with entered grades will be automatically considered as completed and included in GPA calculation</span>
                </li>
                <li>
                    <span class="lang-zh">同名的普通课程和荣誉课程(标有<span class="honors-tag">H</span>标记)在同一学期只能选择其一</span>
                    <span class="lang-en lang-hidden">For courses with the same name, you can only choose either the regular or honors version (marked with <span class="honors-tag">H</span>) in the same semester</span>
                </li>
                <li>
                    <span class="lang-zh">点击"导出Excel表格"将生成包含所有已修读课程详细数据的Excel文件</span>
                    <span class="lang-en lang-hidden">Click "Export to Excel" to generate an Excel file with detailed data of all completed courses</span>
                </li>
            </ul>
        </div>
        
        <footer>
            <p>
                <span class="lang-zh">© 2025 GPA计算器 | 设计用于学术目的</span>
                <span class="lang-en lang-hidden">© 2025 GPA Calculator | Designed for academic purposes</span>
            </p>
        </footer>
    </div>

    <!-- 通知提示组件 -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">
            <span class="lang-zh">操作成功</span>
            <span class="lang-en lang-hidden">Operation successful</span>
        </span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 语言切换功能
            const langBtns = document.querySelectorAll('.lang-btn');
            langBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    
                    // 更新按钮状态
                    langBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换显示语言
                    document.querySelectorAll('.lang-zh, .lang-en').forEach(el => {
                        el.classList.add('lang-hidden');
                    });
                    
                    document.querySelectorAll(`.lang-${lang}`).forEach(el => {
                        el.classList.remove('lang-hidden');
                    });
                    
                    // 更新导出通知文本
                    updateExportNotificationText(lang);
                });
            });
            
            // 更新导出通知文本
            function updateExportNotificationText(lang) {
                const notificationZh = document.querySelector('#notification-text .lang-zh');
                const notificationEn = document.querySelector('#notification-text .lang-en');
                
                if (lang === 'zh') {
                    notificationZh.textContent = 'Excel表格导出成功';
                } else {
                    notificationEn.textContent = 'Excel file exported successfully';
                }
            }
            
            // 课程数据 - 包含中英文名称
            const courses = [
                { id: "001", name: { zh: "学术英语 I", en: "Academic English I" }, honors: 0, credits: 4 },
                { id: "002", name: { zh: "学术英语 I", en: "Academic English I" }, honors: 1, credits: 5 },
                { id: "003", name: { zh: "商务英语", en: "Business English" }, honors: 0, credits: 4 },
                { id: "004", name: { zh: "商务英语", en: "Business English" }, honors: 1, credits: 5 },
                { id: "005", name: { zh: "科学", en: "Science" }, honors: 0, credits: 4 },
                { id: "006", name: { zh: "科学", en: "Science" }, honors: 1, credits: 5 },
                { id: "007", name: { zh: "预备微积分", en: "Pre-Calculus" }, honors: 0, credits: 4 },
                { id: "008", name: { zh: "预备微积分", en: "Pre-Calculus" }, honors: 1, credits: 5 },
                { id: "009", name: { zh: "计算机科学导论", en: "Introduction to Computer Science" }, honors: 0, credits: 3 },
                { id: "010", name: { zh: "ESL 听说", en: "ESL Listening & Speaking" }, honors: 0, credits: 4 },
                { id: "011", name: { zh: "ESL 读写", en: "ESL Reading & Writing" }, honors: 0, credits: 4 },
                { id: "012", name: { zh: "学术英语 II", en: "Academic English II" }, honors: 0, credits: 4 },
                { id: "013", name: { zh: "学术英语 II", en: "Academic English II" }, honors: 1, credits: 5 },
                { id: "014", name: { zh: "ESL", en: "ESL" }, honors: 0, credits: 4 },
                { id: "015", name: { zh: "高级英语", en: "Advanced English" }, honors: 0, credits: 5 },
                { id: "016", name: { zh: "AP 微积分 AB", en: "AP Calculus AB" }, honors: 1, credits: 5 },
                { id: "017", name: { zh: "AP 微积分 BC", en: "AP Calculus BC" }, honors: 1, credits: 5 },
                { id: "018", name: { zh: "微积分", en: "Calculus" }, honors: 0, credits: 4 },
                { id: "019", name: { zh: "AP 微观经济学", en: "AP Microeconomics" }, honors: 1, credits: 5 },
                { id: "020", name: { zh: "AP 宏观经济学", en: "AP Macroeconomics" }, honors: 1, credits: 5 },
                { id: "021", name: { zh: "经济学", en: "Economics" }, honors: 0, credits: 4 },
                { id: "022", name: { zh: "AP 物理 1", en: "AP Physics 1" }, honors: 1, credits: 5 },
                { id: "023", name: { zh: "AP 物理 C", en: "AP Physics C" }, honors: 1, credits: 5 },
                { id: "024", name: { zh: "AP 计算机科学 A", en: "AP Computer Science A" }, honors: 1, credits: 5 },
                { id: "025", name: { zh: "AP 计算机科学原理", en: "AP Computer Science Principles" }, honors: 1, credits: 5 },
                { id: "026", name: { zh: "AP 心理学", en: "AP Psychology" }, honors: 1, credits: 5 },
                { id: "027", name: { zh: "AP 艺术史", en: "AP Art History" }, honors: 1, credits: 5 },
                { id: "028", name: { zh: "AP 语言与写作", en: "AP Language and Composition" }, honors: 1, credits: 5 },
                { id: "029", name: { zh: "AP 统计学", en: "AP Statistics" }, honors: 1, credits: 5 },
                { id: "030", name: { zh: "强化英语", en: "Intensive English" }, honors: 0, credits: 4 },
                { id: "031", name: { zh: "心理学", en: "Psychology" }, honors: 0, credits: 4 },
                { id: "032", name: { zh: "数学与艺术", en: "Mathematics and Art" }, honors: 0, credits: 4 },
                { id: "033", name: { zh: "学术英语 III", en: "Academic English III" }, honors: 0, credits: 4 },
                { id: "034", name: { zh: "学术英语 III", en: "Academic English III" }, honors: 1, credits: 5 },
                { id: "035", name: { zh: "未来技能", en: "Future Skills" }, honors: 0, credits: 4 },
                { id: "036", name: { zh: "顶点课程", en: "Capstone Course" }, honors: 0, credits: 4 },
                // 3个ECA课程
                { id: "037", name: { zh: "ECA - 1", en: "ECA - 1" }, honors: 0, credits: 1 },
                { id: "038", name: { zh: "ECA - 2", en: "ECA - 2" }, honors: 0, credits: 1 },
                { id: "039", name: { zh: "ECA - 3", en: "ECA - 3" }, honors: 0, credits: 1 },
                // 补充课程
                { id: "040", name: { zh: "补充课程", en: "Supplementary Course" }, honors: 0, credits: 2 },
                { id: "041", name: { zh: "补充课程", en: "Supplementary Course" }, honors: 0, credits: 3 },
                { id: "042", name: { zh: "补充课程", en: "Supplementary Course" }, honors: 1, credits: 5 }
            ];

            // 生成课程表格
            const tableBody = document.querySelector('#courses-table tbody');
            const gradeOptions = ['', 'A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];
            
            // 预处理课程，创建普通课程和荣誉课程的关联
            const courseGroups = {};
            
            function getBaseCourseName(name) {
                return name.zh.trim();
            }
            
            function isAPCourse(name) {
                return name.zh.trim().startsWith('AP ') || name.en.trim().startsWith('AP ');
            }
            
            courses.forEach((course, index) => {
                const baseName = getBaseCourseName(course.name);
                if (!courseGroups[baseName]) {
                    courseGroups[baseName] = [];
                }
                courseGroups[baseName].push(index);
            });
            
            // 生成表格行
            courses.forEach((course, index) => {
                const row = document.createElement('tr');
                const baseName = getBaseCourseName(course.name);
                
                // 为荣誉课程组添加特殊背景色
                if (courseGroups[baseName] && courseGroups[baseName].length > 1) {
                    row.classList.add('honors-group');
                }
                
                // 荣誉课程标记
                const honorsTag = course.honors === 1 ? '<span class="honors-tag">H</span>' : '';
                
                // 非AP荣誉课程提示
                const showHonorsTip = course.honors === 1 && !isAPCourse(course.name);
                
                row.innerHTML = `
                    <td class="fixed-column">${course.id}</td>
                    <td class="subject-cell">
                        <span class="lang-zh">${course.name.zh} ${honorsTag}</span>
                        <span class="lang-en lang-hidden">${course.name.en} ${honorsTag}</span>
                        ${showHonorsTip ? 
                            '<span class="tooltip"><i class="fas fa-exclamation-circle" style="color:#dc3545"></i><span class="tooltiptext">' +
                            '<span class="lang-zh">荣誉课程需按20%荣誉+80%普通课程计算综合分数</span>' +
                            '<span class="lang-en lang-hidden">Honors courses are calculated as 20% honors + 80% regular course score</span>' +
                            '</span></span>' : ''}
                    </td>
                    <td>
                        <span class="lang-zh">${course.honors === 1 ? '是' : '否'}</span>
                        <span class="lang-en lang-hidden">${course.honors === 1 ? 'Yes' : 'No'}</span>
                    </td>
                    <td>${course.credits}</td>
                    
                    <!-- 上学期成绩和分数 -->
                    <td class="result-cell" id="points-4-3-${index}-1">0.00</td>
                    <td class="result-cell" id="points-5-0-${index}-1">0.00</td>
                    <td class="result-cell" id="points-4-0-${index}-1">0.00</td>
                    <td class="input-cell">
                        <select id="grade-${index}-1">
                            ${gradeOptions.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                        </select>
                    </td>
                    
                    <!-- 下学期成绩和分数 -->
                    <td class="result-cell" id="points-4-3-${index}-2">0.00</td>
                    <td class="result-cell" id="points-5-0-${index}-2">0.00</td>
                    <td class="result-cell" id="points-4-0-${index}-2">0.00</td>
                    <td class="input-cell">
                        <select id="grade-${index}-2">
                            ${gradeOptions.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                        </select>
                    </td>
                `;
                tableBody.appendChild(row);
                
                // 为上下学期添加事件监听
                for (let semester = 1; semester <= 2; semester++) {
                    const gradeSelect = document.getElementById(`grade-${index}-${semester}`);
                    
                    gradeSelect.addEventListener('change', function() {
                        handleCourseSelectionChange(index, semester);
                        calculateAll();
                    });
                }
            });
            
            // 处理课程选择冲突 - 同一学期内同名课程只能选择其一
            function handleCourseSelectionChange(index, semester) {
                const course = courses[index];
                const baseName = getBaseCourseName(course.name);
                const group = courseGroups[baseName];
                
                if (!group || group.length <= 1) return;
                
                const isSelected = document.getElementById(`grade-${index}-${semester}`).value !== "";
                
                // 如果当前课程被选中，检查同组的其他课程同一学期是否已被选中
                if (isSelected) {
                    group.forEach(otherIndex => {
                        if (otherIndex !== index) {
                            // 如果同组其他课程同一学期已被选中，则取消
                            if (document.getElementById(`grade-${otherIndex}-${semester}`).value !== "") {
                                document.getElementById(`grade-${otherIndex}-${semester}`).value = "";
                            }
                        }
                    });
                }
            }
            
            // 计算所有GPA
            function calculateAll() {
                // 初始化统计数据，包含三种GPA体系
                let stats = {
                    totalPoints43: 0, 
                    totalPoints50: 0, 
                    totalPoints40: 0,
                    totalCredits: 0, 
                    totalCourses: 0, 
                    totalCreditsEarned: 0 
                };
                
                courses.forEach((course, index) => {
                    // 处理两个学期
                    for (let semester = 1; semester <= 2; semester++) {
                        const grade = document.getElementById(`grade-${index}-${semester}`).value;
                        const hasGrade = grade !== "";
                        
                        // 计算分数 - 4.3制
                        let points4_3 = 0;
                        switch(grade) {
                            case 'A+': points4_3 = 4.3; break;
                            case 'A': points4_3 = 4.0; break;
                            case 'A-': points4_3 = 3.7; break;
                            case 'B+': points4_3 = 3.3; break;
                            case 'B': points4_3 = 3.0; break;
                            case 'B-': points4_3 = 2.7; break;
                            case 'C+': points4_3 = 2.3; break;
                            case 'C': points4_3 = 2.0; break;
                            case 'C-': points4_3 = 1.7; break;
                            case 'D+': points4_3 = 1.3; break;
                            case 'D': points4_3 = 1.0; break;
                            case 'D-': points4_3 = 0.7; break;
                            case 'F': points4_3 = 0.0; break;
                            default: points4_3 = 0.0;
                        }
                        
                        // 5.0制分数
                        let points5_0 = Math.min(points4_3 + course.honors, 5.0);
                        
                        // 4.0制分数
                        let points4_0 = 0;
                        switch(grade) {
                            case 'A+': 
                            case 'A': points4_0 = 4.0; break;
                            case 'A-': points4_0 = 3.7; break;
                            case 'B+': points4_0 = 3.3; break;
                            case 'B': points4_0 = 3.0; break;
                            case 'B-': points4_0 = 2.7; break;
                            case 'C+': points4_0 = 2.3; break;
                            case 'C': points4_0 = 2.0; break;
                            case 'C-': points4_0 = 1.7; break;
                            case 'D+': points4_0 = 1.3; break;
                            case 'D': points4_0 = 1.0; break;
                            case 'D-': points4_0 = 0.7; break;
                            case 'F': points4_0 = 0.0; break;
                            default: points4_0 = 0.0;
                        }
                        
                        // 更新显示
                        document.getElementById(`points-4-3-${index}-${semester}`).textContent = points4_3.toFixed(2);
                        document.getElementById(`points-5-0-${index}-${semester}`).textContent = points5_0.toFixed(2);
                        document.getElementById(`points-4-0-${index}-${semester}`).textContent = points4_0.toFixed(2);
                        
                        // 计算学分和统计
                        if (hasGrade) {
                            const creditsEarned = grade === 'F' ? 0 : course.credits;
                            const weightedPoints43 = points4_3 * course.credits;
                            const weightedPoints50 = points5_0 * course.credits;
                            const weightedPoints40 = points4_0 * course.credits;
                            
                            // 更新统计 - 三种GPA体系
                            stats.totalPoints43 += weightedPoints43;
                            stats.totalPoints50 += weightedPoints50;
                            stats.totalPoints40 += weightedPoints40;
                            stats.totalCredits += course.credits;
                            stats.totalCourses += 1;
                            stats.totalCreditsEarned += creditsEarned;
                        }
                    }
                });
                
                // 计算三种GPA
                const gpa43 = stats.totalCredits > 0 ? stats.totalPoints43 / stats.totalCredits : 0;
                const gpa50 = stats.totalCredits > 0 ? stats.totalPoints50 / stats.totalCredits : 0;
                const gpa40 = stats.totalCredits > 0 ? stats.totalPoints40 / stats.totalCredits : 0;
                
                // 更新显示
                document.getElementById('gpa-4-3').textContent = gpa43.toFixed(2);
                document.getElementById('gpa-5-0').textContent = gpa50.toFixed(2);
                document.getElementById('gpa-4-0').textContent = gpa40.toFixed(2);
                document.getElementById('total-credits').textContent = stats.totalCreditsEarned;
                document.getElementById('total-courses').textContent = stats.totalCourses;
            }
            
            // 导出Excel表格功能 - 仅导出有成绩的课程
            document.getElementById('export-excel').addEventListener('click', function() {
                // 获取当前语言
                const currentLang = document.querySelector('.lang-btn.active').getAttribute('data-lang');
                
                // 准备导出数据
                const excelData = [];
                
                // 添加表头
                excelData.push([
                    currentLang === 'zh' ? '序号' : 'No.',
                    currentLang === 'zh' ? '科目名称' : 'Course Name',
                    currentLang === 'zh' ? '荣誉课程' : 'Honors',
                    currentLang === 'zh' ? '学分' : 'Credits',
                    currentLang === 'zh' ? '上学期成绩' : '1st Sem Grade',
                    currentLang === 'zh' ? '上学期4.3制分数' : '1st Sem (4.3 Scale)',
                    currentLang === 'zh' ? '上学期5.0制分数' : '1st Sem (5.0 Scale)',
                    currentLang === 'zh' ? '上学期4.0制分数' : '1st Sem (4.0 Scale)',
                    currentLang === 'zh' ? '下学期成绩' : '2nd Sem Grade',
                    currentLang === 'zh' ? '下学期4.3制分数' : '2nd Sem (4.3 Scale)',
                    currentLang === 'zh' ? '下学期5.0制分数' : '2nd Sem (5.0 Scale)',
                    currentLang === 'zh' ? '下学期4.0制分数' : '2nd Sem (4.0 Scale)'
                ]);
                
                // 添加课程数据 - 包含有成绩的学期
                courses.forEach((course, index) => {
                    // 检查是否有任一学期有成绩
                    const hasGrade1 = document.getElementById(`grade-${index}-1`).value !== "";
                    const hasGrade2 = document.getElementById(`grade-${index}-2`).value !== "";
                    
                    if (hasGrade1 || hasGrade2) {
                        excelData.push([
                            course.id,
                            currentLang === 'zh' ? course.name.zh : course.name.en,
                            currentLang === 'zh' ? (course.honors === 1 ? '是' : '否') : (course.honors === 1 ? 'Yes' : 'No'),
                            course.credits,
                            document.getElementById(`grade-${index}-1`).value || '',
                            document.getElementById(`points-4-3-${index}-1`).textContent,
                            document.getElementById(`points-5-0-${index}-1`).textContent,
                            document.getElementById(`points-4-0-${index}-1`).textContent,
                            document.getElementById(`grade-${index}-2`).value || '',
                            document.getElementById(`points-4-3-${index}-2`).textContent,
                            document.getElementById(`points-5-0-${index}-2`).textContent,
                            document.getElementById(`points-4-0-${index}-2`).textContent
                        ]);
                    }
                });
                
                // 添加GPA汇总数据
                excelData.push([], [currentLang === 'zh' ? 'GPA汇总' : 'GPA Summary']);
                
                const gpa43 = document.getElementById('gpa-4-3').textContent;
                const gpa50 = document.getElementById('gpa-5-0').textContent;
                const gpa40 = document.getElementById('gpa-4-0').textContent;
                const totalCredits = document.getElementById('total-credits').textContent;
                const totalCourses = document.getElementById('total-courses').textContent;
                
                excelData.push(
                    [currentLang === 'zh' ? '平均GPA (4.3制)' : 'Average GPA (4.3 Scale)', gpa43],
                    [currentLang === 'zh' ? '平均GPA (5.0制)' : 'Average GPA (5.0 Scale)', gpa50],
                    [currentLang === 'zh' ? '平均GPA (4.0制)' : 'Average GPA (4.0 Scale)', gpa40],
                    [currentLang === 'zh' ? '总获得学分' : 'Total Credits Earned', totalCredits],
                    [currentLang === 'zh' ? '总课程数' : 'Total Courses', totalCourses]
                );
                
                // 创建工作簿和工作表
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, currentLang === 'zh' ? "成绩单" : "Transcript");
                
                // 生成Excel文件并下载
                const fileName = currentLang === 'zh' 
                    ? `GPA计算结果_${new Date().toISOString().slice(0,10)}.xlsx`
                    : `GPA_Results_${new Date().toISOString().slice(0,10)}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                
                showNotification(currentLang);
            });
            
            // 显示通知提示
            function showNotification(lang) {
                const notification = document.getElementById('notification');
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // 初始计算
            calculateAll();
        });
    </script>
</body>
</html>
